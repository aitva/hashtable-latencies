# Hashtable latencies

This benchmark measures the latency of a web service that stores a large
(250K item) hashtable, in multiple languages.

Garbage collected languages are of greater interest, and the Swift version
is mostly used as a reference of what would be ideal.

# Rules for implementations.

* Each HTTP request will add one new item (and remove one if count > 250K)
* Each item will be a new 1KB buffer with every byte initialized to a value.
* Programs will listen on port 8080 and respond with status 200, body "OK"

# Structure

* All program directories are listed in programs.txt
* Every directory should contain `build.sh` and `run.sh`
* [wrk2](https://github.com/giltene/wrk2) must be installed and linked in $PATH as `wrk2`

# Tests

* Warmup: 10K req/s are sent for 60s (initial hash table content)
* Test 033: 10K req/s are sent by 33  clients concurrently for 60s
* Test 333: 10K req/s are sent by 333 clients concurrently for 60s

# Output:

* All reports are in `reports` directory.
* Charts from both tests can be generated by using [hdrhistogram](http://hdrhistogram.github.io/HdrHistogram/plotFiles.html)

# Current results

33 clients test:

![33](https://github.com/spion/hashtable-latencies/blob/05a0d360725b3d5e6ee57394dee591d9264bd247/reports/033.png)

333 clients test:

![333](https://github.com/spion/hashtable-latencies/blob/05a0d360725b3d5e6ee57394dee591d9264bd247/reports/333.png)

# Program notes

* go - Go version is go1.6.2 darwin/amd64; uses fasthttp
* ocaml-reason - This is OCaml 4.02.3 with a new, JS-like syntax. Follow the [install instructions][rii]
* node - Requires node 6.x (`Buffer.alloc` API)
* haskell - Should build easily if you have [stack][his]
* swift-zewo - You should setup [swiftenv to the right snapshot][swiftenv]

# Conclusions

Want to build low-latency, memory-intensive services in a GCed language? Use
OCaml (or Reason if you prefer the syntax).

# OCaml GC notes

Other things that were attempted to make the latency worse for OCaml:

* random buffer sizes (did not have any noticable increase, <5%)
* longer running time (5 minutes): another 10% latency increase.
* combining above: total latency increase of 15%

Things to try:

* delete keys out of order (might increase heap compaction duration?)

[rii]: https://github.com/facebook/reason/blob/master/README.md#install-stable
[his]: http://docs.haskellstack.org/en/stable/README/#how-to-install
[swiftenv]: https://github.com/Zewo/Zewo#swiftenv
